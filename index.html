<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='180' height='180'><rect fill='%232c5aa0' width='180' height='180'/><text x='90' y='100' text-anchor='middle' fill='white' font-size='80' font-family='sans-serif'>ğŸ“‹</text></svg>">
  <title>æ”¯æ´è¨˜éŒ²ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - ãƒ­ã‚°ã‚¤ãƒ³</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: rgba(0,0,0,0.1);
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'ãƒ¡ã‚¤ãƒªã‚ª', 'Meiryo', sans-serif;
      padding: 10px; 
      background: #f5f5f5;
      margin: 0;
      font-size: 16px;
      -webkit-text-size-adjust: 100%;
    }
    
    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    .login-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
    }
    
    .login-container {
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 400px;
    }
    
    .login-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .login-header h1 {
      color: #2c5aa0;
      margin: 0 0 10px 0;
      font-size: 1.8em;
    }
    
    .login-header p {
      color: #666;
      margin: 0;
      font-size: 0.9em;
    }
    
    .login-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group label {
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .form-group input {
      padding: 14px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      transition: border-color 0.3s;
      min-height: 48px;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #2c5aa0;
    }
    
    .btn-login {
      background: #2c5aa0;
      color: white;
      padding: 16px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
      min-height: 54px;
    }
    
    .btn-login:hover {
      background: #1e3c70;
    }
    
    .login-error {
      background: #fee;
      color: #c33;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #fcc;
      font-size: 14px;
      display: none;
    }
    
    /* ãƒ¡ã‚¤ãƒ³ç”»é¢ */
    .main-screen {
      display: none;
    }
    
    .main-screen.active {
      display: block;
    }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .header h1 {
      margin: 0;
      font-size: 1.5em;
      flex: 1;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
      background: rgba(255,255,255,0.2);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.95em;
    }
    
    .btn-logout {
      background: rgba(255,255,255,0.3);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background 0.3s;
      min-height: 36px;
    }
    
    .btn-logout:hover {
      background: rgba(255,255,255,0.5);
    }
    
    h2 { 
      color: #2c5aa0;
      border-left: 4px solid #2c5aa0;
      padding-left: 10px;
      margin-top: 30px;
      margin-bottom: 15px;
    }
    
    .btn {
      padding: 12px 20px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      min-height: 48px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    /* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
    .btn-add { background: #4CAF50; color: white; }
    .btn-add:hover { background: #45a049; transform: translateY(-2px); }
    .btn-add:active { transform: translateY(0); }
    
    .btn-save { background: #2196F3; color: white; }
    .btn-save:hover { background: #0b7dda; }
    
    .btn-export { background: #FF9800; color: white; }
    .btn-export:hover { background: #e68900; }
    
    .btn-clear { background: #f44336; color: white; }
    .btn-clear:hover { background: #da190b; }
    
    .btn-cancel { background: #999; color: white; }
    .btn-cancel:hover { background: #777; }
    
    .btn-master { background: #9C27B0; color: white; }
    .btn-master:hover { background: #7B1FA2; }
    
    .btn-sync { background: #00BCD4; color: white; }
    .btn-sync:hover { background: #00ACC1; }
    
    .btn-remove { background: #ff5722; color: white; padding: 8px 16px; font-size: 14px; }
    .btn-remove:hover { background: #e64a19; }
    
    .btn-voice { 
      background: #673AB7; 
      color: white; 
      padding: 6px 12px; 
      font-size: 14px; 
      border-radius: 4px;
      margin-left: 8px;
    }
    .btn-voice:hover { background: #5E35B1; }
    
    .btn-toggle {
      background: #607D8B;
      color: white;
      width: 100%;
      margin: 15px 0;
      font-size: 15px;
    }
    .btn-toggle:hover {
      background: #546E7A;
    }
    .btn-toggle.active {
      background: #E91E63;
    }
    
    /* ä¸€æ‹¬å…¥åŠ›ãƒœã‚¿ãƒ³ï¼ˆNEWï¼‰ */
    .btn-batch { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; 
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(102,126,234,0.4);
    }
    .btn-batch:hover { 
      box-shadow: 0 6px 20px rgba(102,126,234,0.6);
      transform: translateY(-2px);
    }
    
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    /* ä¸€æ‹¬å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆNEWï¼‰ */
    .batch-modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      overflow: auto;
    }
    
    .batch-modal-content {
      background-color: #fff;
      margin: 3% auto;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    
    .batch-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #eee;
    }
    
    .batch-header h2 {
      margin: 0;
      color: #667eea;
      border: none;
      padding: 0;
    }
    
    .batch-close {
      font-size: 32px;
      font-weight: bold;
      color: #999;
      cursor: pointer;
      transition: color 0.3s;
      background: none;
      border: none;
      padding: 0;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .batch-close:hover {
      color: #333;
    }
    
    .batch-section {
      margin-bottom: 25px;
    }
    
    .batch-section-title {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 15px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .user-selection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 15px;
    }
    
    .user-checkbox-item {
      display: flex;
      align-items: center;
      padding: 12px;
      background: #f9f9f9;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .user-checkbox-item:hover {
      background: #f0f0f0;
      border-color: #667eea;
    }
    
    .user-checkbox-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      cursor: pointer;
    }
    
    .user-checkbox-item.checked {
      background: #e8eaf6;
      border-color: #667eea;
      font-weight: bold;
    }
    
    .select-all-btn {
      background: #667eea;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 15px;
      transition: background 0.3s;
    }
    
    .select-all-btn:hover {
      background: #5568d3;
    }
    
    .batch-input-field {
      margin-bottom: 20px;
    }
    
    .batch-input-field label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
      color: #555;
    }
    
    .batch-input-field input,
    .batch-input-field select,
    .batch-input-field textarea {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 6px;
      transition: border-color 0.3s;
    }
    
    .batch-input-field input:focus,
    .batch-input-field select:focus,
    .batch-input-field textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .batch-input-field textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    .batch-time-range {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .batch-time-range input {
      flex: 1;
    }
    
    .batch-actions {
      display: flex;
      gap: 15px;
      justify-content: flex-end;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #eee;
    }
    
    .btn-batch-save {
      background: #4CAF50;
      color: white;
      padding: 14px 30px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: background 0.3s;
    }
    
    .btn-batch-save:hover {
      background: #45a049;
    }
    
    .btn-batch-cancel {
      background: #999;
      color: white;
      padding: 14px 30px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s;
    }
    
    .btn-batch-cancel:hover {
      background: #777;
    }
    
    .selected-count {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: bold;
      margin-left: 10px;
    }
    
    /* æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã®ç¶šã */
    .input-row {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 2px solid #e0e0e0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .input-row.active {
      border-color: #2c5aa0;
      box-shadow: 0 4px 16px rgba(44,90,160,0.15);
    }
    
    .basic-info-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .input-field {
      display: flex;
      flex-direction: column;
    }
    
    .input-field label {
      font-weight: bold;
      margin-bottom: 6px;
      font-size: 14px;
      color: #555;
      display: flex;
      align-items: center;
    }
    
    .required {
      color: red;
      margin-left: 4px;
    }
    
    .input-field input,
    .input-field select,
    .input-field textarea {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-height: 44px;
    }
    
    .input-field input:focus,
    .input-field select:focus,
    .input-field textarea:focus {
      outline: none;
      border-color: #2c5aa0;
      box-shadow: 0 0 0 2px rgba(44,90,160,0.1);
    }
    
    .input-field textarea {
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
    }
    
    .input-field-time {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .input-field-time input {
      flex: 1;
    }
    
    .input-field-time span {
      font-weight: bold;
      color: #666;
    }
    
    /* æ”¯æ´å†…å®¹ã‚¨ãƒªã‚¢ */
    .support-input-area,
    .vital-input-area {
      display: none;
    }
    
    .support-input-area.active,
    .vital-input-area.active {
      display: block;
    }
    
    .support-content-section {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    
    .support-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      font-weight: bold;
      font-size: 18px;
      color: #2c5aa0;
    }
    
    .support-content-row {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 12px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 2px solid #e0e0e0;
      position: relative;
    }
    
    .support-number {
      background: #667eea;
      color: white;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: bold;
      margin-right: 6px;
    }
    
    .support-actions {
      grid-column: 1 / -1;
      display: flex;
      justify-content: flex-end;
      margin-top: 10px;
    }
    
    /* ãƒã‚¤ã‚¿ãƒ«ã‚¨ãƒªã‚¢ */
    .vital-section {
      background: #fff5f5;
      padding: 20px;
      border-radius: 8px;
    }
    
    .vital-entry {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 2px solid #ffcdd2;
    }
    
    .vital-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #ffebee;
    }
    
    .vital-number {
      background: #E91E63;
      color: white;
      padding: 6px 14px;
      border-radius: 16px;
      font-size: 14px;
      font-weight: bold;
    }
    
    .vital-time {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .vital-time label {
      font-weight: bold;
      font-size: 14px;
    }
    
    .vital-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }
    
    .vital-field {
      display: flex;
      flex-direction: column;
    }
    
    .vital-field label {
      font-weight: bold;
      font-size: 13px;
      margin-bottom: 6px;
      color: #555;
    }
    
    .vital-field input {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .row-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ« */
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    th {
      padding: 15px;
      text-align: left;
      font-weight: bold;
      font-size: 15px;
    }
    
    td {
      padding: 15px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }
    
    tbody tr:hover {
      background: #f5f5f5;
    }
    
    .service-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: bold;
      color: white;
    }
    
    /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
    .filter-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .filter-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .filter-row label {
      font-weight: bold;
      display: block;
      margin-bottom: 6px;
      color: #555;
    }
    
    .filter-row input,
    .filter-row select {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-height: 44px;
    }
    
    .filter-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 3% auto;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 900px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #eee;
    }
    
    .modal-header h2 {
      margin: 0;
      color: #9C27B0;
      border: none;
      padding: 0;
    }
    
    .close {
      color: #aaa;
      font-size: 32px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s;
      background: none;
      border: none;
      padding: 0;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .close:hover {
      color: #000;
    }
    
    .master-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .master-tab {
      padding: 12px 20px;
      background: #f0f0f0;
      border: none;
      border-radius: 6px 6px 0 0;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
      min-height: 44px;
    }
    
    .master-tab.active {
      background: #9C27B0;
      color: white;
      font-weight: bold;
    }
    
    .master-tab-content {
      display: none;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
    }
    
    .master-tab-content.active {
      display: block;
    }
    
    .master-add-form {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .master-add-form input,
    .master-add-form select {
      flex: 1;
      min-width: 200px;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-height: 44px;
    }
    
    .master-list {
      display: grid;
      gap: 10px;
    }
    
    .master-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: white;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
    }
    
    .master-item-info {
      flex: 1;
    }
    
    .master-item-name {
      font-weight: bold;
      font-size: 15px;
      color: #333;
    }
    
    .master-item-detail {
      font-size: 13px;
      color: #666;
      margin-top: 4px;
    }
    
    .master-item-mapping {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    
    .condition-chip {
      display: inline-block;
      padding: 4px 10px;
      background: #e3f2fd;
      color: #1976d2;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .btn-delete {
      background: #f44336;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      min-height: 36px;
      transition: background 0.3s;
    }
    
    .btn-delete:hover {
      background: #da190b;
    }
    
    .condition-mapping-section {
      margin-top: 20px;
    }
    
    .mapping-controls {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .mapping-controls select {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-height: 44px;
    }
    
    /* åŒæœŸãƒ¢ãƒ¼ãƒ€ãƒ« */
    .sync-section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
    }
    
    .sync-section h3 {
      margin-top: 0;
      color: #00BCD4;
      margin-bottom: 15px;
    }
    
    .sync-url-input {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .sync-url-input input {
      flex: 1;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-height: 48px;
    }
    
    .sync-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .sync-status {
      margin-top: 15px;
      padding: 12px;
      border-radius: 6px;
      font-size: 14px;
      display: none;
    }
    
    .sync-status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .sync-status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    /* ãƒ­ã‚°ã‚¤ãƒ³IDãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç®¡ç† */
    .login-management-form {
      display: grid;
      gap: 20px;
    }
    
    .login-management-form .input-field input {
      width: 100%;
    }
    
    .password-hint {
      background: #fff3cd;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #ffeeba;
      color: #856404;
      font-size: 14px;
      margin-top: 10px;
    }
    
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .header h1 {
        font-size: 1.3em;
        text-align: center;
      }
      
      .user-info {
        justify-content: center;
      }
      
      .controls {
        flex-direction: column;
      }
      
      .controls .btn {
        width: 100%;
      }
      
      .support-content-row {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .support-actions {
        grid-column: 1 / -1;
      }
      
      .basic-info-row {
        grid-template-columns: 1fr;
      }
      
      .filter-row {
        grid-template-columns: 1fr;
      }
      
      .master-tabs {
        flex-direction: column;
      }
      
      .master-tab {
        border-radius: 6px;
      }
      
      table {
        font-size: 14px;
      }
      
      th, td {
        padding: 10px 8px;
      }
      
      .modal-content {
        width: 95%;
        padding: 20px;
        margin: 5% auto;
      }
      
      .batch-modal-content {
        width: 95%;
        padding: 20px;
        margin: 5% auto;
      }
      
      .user-selection-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 5px;
        font-size: 14px;
      }
      
      .header {
        padding: 15px;
      }
      
      .input-row {
        padding: 15px;
      }
      
      .btn {
        font-size: 14px;
        padding: 10px 16px;
      }
      
      .support-content-row {
        grid-template-columns: 1fr;
        gap: 10px;
        padding: 15px;
      }
      
      .vital-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

<!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
<div id="loginScreen" class="login-screen">
  <div class="login-container">
    <div class="login-header">
      <h1>ğŸ“‹ æ”¯æ´è¨˜éŒ²ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
      <p>ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
    </div>
    
    <div id="loginError" class="login-error"></div>
    
    <form class="login-form" onsubmit="handleLogin(event)">
      <div class="form-group">
        <label for="loginId">ãƒ­ã‚°ã‚¤ãƒ³ID</label>
        <input type="text" id="loginId" required autocomplete="username">
      </div>
      
      <div class="form-group">
        <label for="loginPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="loginPassword" required autocomplete="current-password">
      </div>
      
      <button type="submit" class="btn-login">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </form>
  </div>
</div>

<!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
<div id="mainScreen" class="main-screen">
  <div class="header">
    <h1>ğŸ“‹ æ”¯æ´è¨˜éŒ²ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
    <div class="user-info">
      <span>ğŸ‘¤ <span id="currentUserName"></span></span>
      <button class="btn-logout" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>
  
  <div class="controls">
    <button class="btn btn-add" onclick="addInputRow()">â• æ–°è¦è¨˜éŒ²</button>
    <button class="btn btn-batch" onclick="openBatchModal()">ğŸ“‹ ä¸€æ‹¬å…¥åŠ›</button>
    <button class="btn btn-export" onclick="exportExcel()">ğŸ“¥ Excelå‡ºåŠ›</button>
    <button class="btn btn-master" onclick="openMasterModal()">âš™ï¸ ãƒã‚¹ã‚¿ãƒ¼</button>
    <button class="btn btn-sync" onclick="openSyncModal()">â˜ï¸ åŒæœŸ</button>
    <button class="btn btn-clear" onclick="clearAll()">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
  </div>
  
  <h2>ğŸ“ è¨˜éŒ²å…¥åŠ›</h2>
  <div id="inputContainer"></div>
  
  <h2>ğŸ“Š è¨˜éŒ²ä¸€è¦§</h2>
  <div class="filter-section">
    <div class="filter-row">
      <div>
        <label>æœˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
        <input type="month" id="filterMonth">
      </div>
      <div>
        <label>ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†</label>
        <select id="filterService">
          <option value="">ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ï¼ˆå…¨ã¦ï¼‰</option>
        </select>
      </div>
      <div>
        <label>åˆ©ç”¨è€…å</label>
        <input type="text" id="filterUser" placeholder="åˆ©ç”¨è€…åã§æ¤œç´¢">
      </div>
    </div>
    <div class="filter-actions">
      <button class="btn btn-save" onclick="applyFilter()">ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨</button>
      <button class="btn btn-cancel" onclick="resetFilter()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>
  
  <table id="recordTable">
    <thead>
      <tr>
        <th>è¨˜éŒ²æ—¥</th>
        <th>ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†</th>
        <th>åˆ©ç”¨è€…å</th>
        <th>è¨˜éŒ²è€…å</th>
        <th>è¨˜éŒ²å†…å®¹</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- ä¸€æ‹¬å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆNEWï¼‰ -->
<div id="batchModal" class="batch-modal">
  <div class="batch-modal-content">
    <div class="batch-header">
      <h2>ğŸ“‹ è¤‡æ•°åˆ©ç”¨è€…ã®ä¸€æ‹¬å…¥åŠ›</h2>
      <button class="batch-close" onclick="closeBatchModal()">&times;</button>
    </div>
    
    <!-- Step 1: åˆ©ç”¨è€…é¸æŠ -->
    <div class="batch-section">
      <div class="batch-section-title">
        â‘  åˆ©ç”¨è€…ã‚’é¸æŠ
        <span id="selectedCountBadge" class="selected-count">0äººé¸æŠä¸­</span>
      </div>
      <button class="select-all-btn" onclick="toggleSelectAllUsers()">å…¨å“¡é¸æŠ / è§£é™¤</button>
      <div id="userSelectionGrid" class="user-selection-grid"></div>
    </div>
    
    <!-- Step 2: åŸºæœ¬æƒ…å ±å…¥åŠ› -->
    <div class="batch-section">
      <div class="batch-section-title">â‘¡ åŸºæœ¬æƒ…å ±</div>
      <div class="batch-input-field">
        <label>è¨˜éŒ²æ—¥ <span class="required">*</span></label>
        <input type="date" id="batchDate" required>
      </div>
      <div class="batch-input-field">
        <label>ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ† <span class="required">*</span></label>
        <select id="batchService" required>
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
      </div>
      <div class="batch-input-field">
        <label>è¨˜éŒ²è€…å <span class="required">*</span></label>
        <select id="batchStaff" required>
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
      </div>
    </div>
    
    <!-- Step 3: æ”¯æ´å†…å®¹å…¥åŠ› -->
    <div class="batch-section">
      <div class="batch-section-title">â‘¢ æ”¯æ´å†…å®¹ï¼ˆå…¨å“¡å…±é€šï¼‰</div>
      <div class="batch-input-field">
        <label>æ”¯æ´å†…å®¹ <span class="required">*</span></label>
        <select id="batchSupportType" required>
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
      </div>
      <div class="batch-input-field">
        <label>æ™‚é–“ç¯„å›²</label>
        <div class="batch-time-range">
          <input type="time" id="batchStartTime">
          <span>ã€œ</span>
          <input type="time" id="batchEndTime">
        </div>
      </div>
      <div class="batch-input-field">
        <label>æ§˜å­ãƒ»çŠ¶æ…‹</label>
        <select id="batchCondition">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
      </div>
      <div class="batch-input-field">
        <label>æ´»å‹•å ´æ‰€</label>
        <select id="batchLocation">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
      </div>
      <div class="batch-input-field">
        <label>æ´»å‹•å†…å®¹</label>
        <select id="batchActivity">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
      </div>
      <div class="batch-input-field">
        <label>
          æ”¯æ´ã®è©³ç´°
          <button type="button" class="btn-voice" onclick="startVoiceInput(document.getElementById('batchDetail'))" title="éŸ³å£°å…¥åŠ›">ğŸ¤</button>
        </label>
        <textarea id="batchDetail" placeholder="ã‚¤ãƒ™ãƒ³ãƒˆå†…å®¹ã‚„æ´»å‹•ã®è©³ç´°ã‚’å…¥åŠ›"></textarea>
      </div>
      <div class="batch-input-field">
        <label>
          ç‰¹è¨˜äº‹é …
          <button type="button" class="btn-voice" onclick="startVoiceInput(document.getElementById('batchNote'))" title="éŸ³å£°å…¥åŠ›">ğŸ¤</button>
        </label>
        <textarea id="batchNote" placeholder="ç‰¹è¨˜äº‹é …ãŒã‚ã‚Œã°å…¥åŠ›"></textarea>
      </div>
    </div>
    
    <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
    <div class="batch-actions">
      <button class="btn-batch-save" onclick="saveBatchRecords()">âœ“ ä¸€æ‹¬ä¿å­˜</button>
      <button class="btn-batch-cancel" onclick="closeBatchModal()">âœ• ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<!-- ãƒã‚¹ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="masterModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>âš™ï¸ ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
      <button class="close" onclick="closeMasterModal()">&times;</button>
    </div>
    
    <div class="master-tabs">
      <button class="master-tab active" onclick="switchMasterTab('users')">åˆ©ç”¨è€…</button>
      <button class="master-tab" onclick="switchMasterTab('services')">ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†</button>
      <button class="master-tab" onclick="switchMasterTab('staff')">è¨˜éŒ²è€…</button>
      <button class="master-tab" onclick="switchMasterTab('supportTypes')">æ”¯æ´å†…å®¹</button>
      <button class="master-tab" onclick="switchMasterTab('conditions')">æ§˜å­ãƒ»çŠ¶æ…‹</button>
      <button class="master-tab" onclick="switchMasterTab('locations')">æ´»å‹•å ´æ‰€</button>
      <button class="master-tab" onclick="switchMasterTab('activityTypes')">æ´»å‹•å†…å®¹</button>
      <button class="master-tab" onclick="switchMasterTab('conditionMapping')">é€£å‹•è¨­å®š</button>
      <button class="master-tab" onclick="switchMasterTab('loginManagement')">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³IDãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç®¡ç†</button>
    </div>
    
    <!-- åˆ©ç”¨è€…ã‚¿ãƒ– -->
    <div id="tab-users" class="master-tab-content active">
      <div class="master-add-form">
        <input type="text" id="newUserName" placeholder="åˆ©ç”¨è€…å">
        <select id="newUserService">
          <option value="">ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†</option>
        </select>
        <button class="btn btn-add" onclick="addUser()">â• è¿½åŠ </button>
      </div>
      <div id="userList" class="master-list"></div>
    </div>
    
    <!-- ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ã‚¿ãƒ– -->
    <div id="tab-services" class="master-tab-content">
      <div class="master-add-form">
        <input type="text" id="newService" placeholder="ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†å">
        <button class="btn btn-add" onclick="addService()">â• è¿½åŠ </button>
      </div>
      <div id="serviceList" class="master-list"></div>
    </div>
    
    <!-- è¨˜éŒ²è€…ã‚¿ãƒ– -->
    <div id="tab-staff" class="master-tab-content">
      <div class="master-add-form">
        <input type="text" id="newStaff" placeholder="è¨˜éŒ²è€…å">
        <button class="btn btn-add" onclick="addStaff()">â• è¿½åŠ </button>
      </div>
      <div id="staffList" class="master-list"></div>
    </div>
    
    <!-- æ”¯æ´å†…å®¹ã‚¿ãƒ– -->
    <div id="tab-supportTypes" class="master-tab-content">
      <div class="master-add-form">
        <input type="text" id="newSupportType" placeholder="æ”¯æ´å†…å®¹">
        <button class="btn btn-add" onclick="addSupportType()">â• è¿½åŠ </button>
      </div>
      <div id="supportTypeList" class="master-list"></div>
    </div>
    
    <!-- æ§˜å­ãƒ»çŠ¶æ…‹ã‚¿ãƒ– -->
    <div id="tab-conditions" class="master-tab-content">
      <div class="master-add-form">
        <input type="text" id="newCondition" placeholder="æ§˜å­ãƒ»çŠ¶æ…‹">
        <button class="btn btn-add" onclick="addCondition()">â• è¿½åŠ </button>
      </div>
      <div id="conditionList" class="master-list"></div>
    </div>
    
    <!-- æ´»å‹•å ´æ‰€ã‚¿ãƒ– -->
    <div id="tab-locations" class="master-tab-content">
      <div class="master-add-form">
        <input type="text" id="newLocation" placeholder="æ´»å‹•å ´æ‰€">
        <button class="btn btn-add" onclick="addLocation()">â• è¿½åŠ </button>
      </div>
      <div id="locationList" class="master-list"></div>
    </div>
    
    <!-- æ´»å‹•å†…å®¹ã‚¿ãƒ– -->
    <div id="tab-activityTypes" class="master-tab-content">
      <div class="master-add-form">
        <input type="text" id="newActivityType" placeholder="æ´»å‹•å†…å®¹">
        <button class="btn btn-add" onclick="addActivityType()">â• è¿½åŠ </button>
      </div>
      <div id="activityTypeList" class="master-list"></div>
    </div>
    
    <!-- é€£å‹•è¨­å®šã‚¿ãƒ– -->
    <div id="tab-conditionMapping" class="master-tab-content">
      <div class="condition-mapping-section">
        <h3>æ”¯æ´å†…å®¹ã¨æ§˜å­ãƒ»çŠ¶æ…‹ã®é€£å‹•è¨­å®š</h3>
        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
          æ”¯æ´å†…å®¹ã‚’é¸æŠã™ã‚‹ã¨ã€è©²å½“ã™ã‚‹æ§˜å­ãƒ»çŠ¶æ…‹ã®ã¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
        </p>
        <div class="mapping-controls">
          <select id="mappingSupportType">
            <option value="">æ”¯æ´å†…å®¹ã‚’é¸æŠ</option>
          </select>
          <select id="mappingCondition">
            <option value="">æ§˜å­ãƒ»çŠ¶æ…‹ã‚’é¸æŠ</option>
          </select>
          <button class="btn btn-add" onclick="addConditionMapping()">â• é€£å‹•è¿½åŠ </button>
        </div>
        <div id="conditionMappingList" class="master-list"></div>
      </div>
    </div>
    
    <!-- ãƒ­ã‚°ã‚¤ãƒ³IDãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç®¡ç†ã‚¿ãƒ– -->
    <div id="tab-loginManagement" class="master-tab-content">
      <h3>ğŸ” ãƒ­ã‚°ã‚¤ãƒ³IDãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š</h3>
      <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
        ã‚·ã‚¹ãƒ†ãƒ ã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ãŸã‚ã®IDãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã§ãã¾ã™
      </p>
      <div class="login-management-form">
        <div class="input-field">
          <label>æ–°ã—ã„ãƒ­ã‚°ã‚¤ãƒ³ID <span class="required">*</span></label>
          <input type="text" id="newLoginId" placeholder="æ–°ã—ã„ãƒ­ã‚°ã‚¤ãƒ³ID">
        </div>
        <div class="input-field">
          <label>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ <span class="required">*</span></label>
          <input type="password" id="newLoginPassword" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰">
        </div>
        <div class="input-field">
          <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰ <span class="required">*</span></label>
          <input type="password" id="newLoginPasswordConfirm" placeholder="ã‚‚ã†ä¸€åº¦å…¥åŠ›">
        </div>
        <div class="password-hint">
          âš ï¸ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„ã€‚å¤‰æ›´å¾Œã¯æ–°ã—ã„IDãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚
        </div>
        <button class="btn btn-save" onclick="updateLoginCredentials()" style="margin-top: 10px;">âœ“ å¤‰æ›´ã‚’ä¿å­˜</button>
      </div>
    </div>
  </div>
</div>

<!-- åŒæœŸãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="syncModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>â˜ï¸ Google Sheets åŒæœŸ</h2>
      <button class="close" onclick="closeSyncModal()">&times;</button>
    </div>
    
    <div class="sync-section">
      <h3>âš™ï¸ Google Sheets API URLè¨­å®š</h3>
      <div class="sync-url-input">
        <input type="url" id="syncUrl" placeholder="https://script.google.com/macros/s/.../exec">
        <button class="btn btn-save" onclick="saveSyncUrl()">ä¿å­˜</button>
      </div>
      <p style="color: #666; font-size: 14px; margin-top: 10px;">
        â€» Google Apps Scriptã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’è¨­å®šã—ã¦ãã ã•ã„
      </p>
    </div>
    
    <div class="sync-section">
      <h3>ğŸ“¤ ãƒ‡ãƒ¼ã‚¿åŒæœŸ</h3>
      <div class="sync-buttons">
        <button class="btn btn-sync" onclick="syncToCloud()">â¬†ï¸ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
        <button class="btn btn-sync" onclick="syncFromCloud()">â¬‡ï¸ ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      </div>
      <div id="syncStatus" class="sync-status"></div>
    </div>
  </div>
</div>

<script>
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
  let records = JSON.parse(localStorage.getItem('records') || '[]');
  let filtered = [...records];
  let rowIdCounter = 0;
  let supportCounterMap = {};
  let vitalCounterMap = {};
  
  // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿
  let masterUsers = JSON.parse(localStorage.getItem('masterUsers') || '[]');
  let masterServices = JSON.parse(localStorage.getItem('masterServices') || '[]');
  let masterStaff = JSON.parse(localStorage.getItem('masterStaff') || '[]');
  let masterSupportTypes = JSON.parse(localStorage.getItem('masterSupportTypes') || '[]');
  let masterConditions = JSON.parse(localStorage.getItem('masterConditions') || '[]');
  let masterLocations = JSON.parse(localStorage.getItem('masterLocations') || '[]');
  let masterActivityTypes = JSON.parse(localStorage.getItem('masterActivityTypes') || '[]');
  let supportConditionMap = JSON.parse(localStorage.getItem('supportConditionMap') || '{}');
  
  // éŸ³å£°èªè­˜
  let recognition = null;
  let currentVoiceInput = null;
  
  // ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½
  const SESSION_DURATION = 24 * 60 * 60 * 1000; // 24æ™‚é–“
  
  function checkSession() {
    const loginTime = localStorage.getItem('loginTime');
    const currentTime = new Date().getTime();
    
    if (!loginTime || (currentTime - parseInt(loginTime)) > SESSION_DURATION) {
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ‡ã‚Œ
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('mainScreen').classList.remove('active');
      return false;
    }
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹
    const credentials = JSON.parse(localStorage.getItem('loginCredentials') || '{"id":"admin","password":"admin123"}');
    document.getElementById('currentUserName').textContent = credentials.id;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainScreen').classList.add('active');
    return true;
  }
  
  function handleLogin(event) {
    event.preventDefault();
    
    const inputId = document.getElementById('loginId').value.trim();
    const inputPassword = document.getElementById('loginPassword').value;
    const errorEl = document.getElementById('loginError');
    
    const credentials = JSON.parse(localStorage.getItem('loginCredentials') || '{"id":"admin","password":"admin123"}');
    
    if (inputId === credentials.id && inputPassword === credentials.password) {
      // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
      localStorage.setItem('loginTime', new Date().getTime().toString());
      document.getElementById('currentUserName').textContent = credentials.id;
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainScreen').classList.add('active');
      errorEl.style.display = 'none';
    } else {
      // ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—
      errorEl.textContent = 'âŒ ãƒ­ã‚°ã‚¤ãƒ³IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
      errorEl.style.display = 'block';
    }
  }
  
  function logout() {
    if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
      localStorage.removeItem('loginTime');
      document.getElementById('loginId').value = '';
      document.getElementById('loginPassword').value = '';
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('mainScreen').classList.remove('active');
    }
  }
  
  function updateLoginCredentials() {
    const newId = document.getElementById('newLoginId').value.trim();
    const newPass = document.getElementById('newLoginPassword').value;
    const confirmPass = document.getElementById('newLoginPasswordConfirm').value;
    
    if (!newId || !newPass || !confirmPass) {
      alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (newPass.length < 6) {
      alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„');
      return;
    }
    
    if (newPass !== confirmPass) {
      alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
      return;
    }
    
    if (confirm('ãƒ­ã‚°ã‚¤ãƒ³IDãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã™ã‹?\nå¤‰æ›´å¾Œã¯æ–°ã—ã„IDãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚')) {
      const credentials = { id: newId, password: newPass };
      localStorage.setItem('loginCredentials', JSON.stringify(credentials));
      localStorage.removeItem('loginTime');
      
      alert('âœ“ ãƒ­ã‚°ã‚¤ãƒ³IDãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
      
      document.getElementById('newLoginId').value = '';
      document.getElementById('newLoginPassword').value = '';
      document.getElementById('newLoginPasswordConfirm').value = '';
      
      closeMasterModal();
      logout();
    }
  }
  
  // ä¸€æ‹¬å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ï¼ˆNEWï¼‰
  let selectedUserIds = new Set();
  
  function openBatchModal() {
    if (masterUsers.length === 0) {
      alert('ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã«åˆ©ç”¨è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nå…ˆã«ã€Œâš™ï¸ ãƒã‚¹ã‚¿ãƒ¼ã€ã‹ã‚‰åˆ©ç”¨è€…ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    
    // åˆ©ç”¨è€…é¸æŠã‚°ãƒªãƒƒãƒ‰ã‚’ç”Ÿæˆ
    const grid = document.getElementById('userSelectionGrid');
    grid.innerHTML = '';
    
    masterUsers.forEach((user, index) => {
      const div = document.createElement('div');
      div.className = 'user-checkbox-item';
      div.onclick = () => toggleUserSelection(index, div);
      
      div.innerHTML = `
        <input type="checkbox" id="user-${index}" onclick="event.stopPropagation(); toggleUserSelection(${index}, this.parentElement)">
        <label for="user-${index}" style="cursor: pointer; flex: 1;">${user.name}ï¼ˆ${user.service}ï¼‰</label>
      `;
      
      grid.appendChild(div);
    });
    
    // åˆæœŸåŒ–
    selectedUserIds.clear();
    updateSelectedCount();
    
    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆ
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('batchDate').value = today;
    
    // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®é¸æŠè‚¢ã‚’è¨­å®š
    populateBatchSelects();
    
    // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('batchService').value = '';
    document.getElementById('batchStaff').value = '';
    document.getElementById('batchSupportType').value = '';
    document.getElementById('batchStartTime').value = '';
    document.getElementById('batchEndTime').value = '';
    document.getElementById('batchCondition').value = '';
    document.getElementById('batchLocation').value = '';
    document.getElementById('batchActivity').value = '';
    document.getElementById('batchDetail').value = '';
    document.getElementById('batchNote').value = '';
    
    document.getElementById('batchModal').style.display = 'block';
  }
  
  function closeBatchModal() {
    document.getElementById('batchModal').style.display = 'none';
    selectedUserIds.clear();
  }
  
  function toggleUserSelection(index, element) {
    const checkbox = element.querySelector('input[type="checkbox"]');
    
    if (selectedUserIds.has(index)) {
      selectedUserIds.delete(index);
      element.classList.remove('checked');
      checkbox.checked = false;
    } else {
      selectedUserIds.add(index);
      element.classList.add('checked');
      checkbox.checked = true;
    }
    
    updateSelectedCount();
  }
  
  function toggleSelectAllUsers() {
    const grid = document.getElementById('userSelectionGrid');
    const items = grid.querySelectorAll('.user-checkbox-item');
    
    if (selectedUserIds.size === masterUsers.length) {
      // å…¨è§£é™¤
      selectedUserIds.clear();
      items.forEach((item, index) => {
        item.classList.remove('checked');
        item.querySelector('input[type="checkbox"]').checked = false;
      });
    } else {
      // å…¨é¸æŠ
      selectedUserIds.clear();
      items.forEach((item, index) => {
        selectedUserIds.add(index);
        item.classList.add('checked');
        item.querySelector('input[type="checkbox"]').checked = true;
      });
    }
    
    updateSelectedCount();
  }
  
  function updateSelectedCount() {
    document.getElementById('selectedCountBadge').textContent = `${selectedUserIds.size}äººé¸æŠä¸­`;
  }
  
  function populateBatchSelects() {
    // ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†
    const serviceSelect = document.getElementById('batchService');
    serviceSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    masterServices.forEach(service => {
      const option = document.createElement('option');
      option.value = service;
      option.textContent = service;
      serviceSelect.appendChild(option);
    });
    
    // è¨˜éŒ²è€…
    const staffSelect = document.getElementById('batchStaff');
    staffSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    masterStaff.forEach(staff => {
      const option = document.createElement('option');
      option.value = staff;
      option.textContent = staff;
      staffSelect.appendChild(option);
    });
    
    // æ”¯æ´å†…å®¹
    const supportSelect = document.getElementById('batchSupportType');
    supportSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    masterSupportTypes.forEach(type => {
      const option = document.createElement('option');
      option.value = type;
      option.textContent = type;
      supportSelect.appendChild(option);
    });
    
    // æ§˜å­ãƒ»çŠ¶æ…‹
    const conditionSelect = document.getElementById('batchCondition');
    conditionSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    masterConditions.forEach(cond => {
      const option = document.createElement('option');
      option.value = cond;
      option.textContent = cond;
      conditionSelect.appendChild(option);
    });
    
    // æ´»å‹•å ´æ‰€
    const locationSelect = document.getElementById('batchLocation');
    locationSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    masterLocations.forEach(loc => {
      const option = document.createElement('option');
      option.value = loc;
      option.textContent = loc;
      locationSelect.appendChild(option);
    });
    
    // æ´»å‹•å†…å®¹
    const activitySelect = document.getElementById('batchActivity');
    activitySelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    masterActivityTypes.forEach(act => {
      const option = document.createElement('option');
      option.value = act;
      option.textContent = act;
      activitySelect.appendChild(option);
    });
  }
  
  function saveBatchRecords() {
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (selectedUserIds.size === 0) {
      alert('åˆ©ç”¨è€…ã‚’1äººä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    
    const date = document.getElementById('batchDate').value;
    const service = document.getElementById('batchService').value;
    const staff = document.getElementById('batchStaff').value;
    const supportType = document.getElementById('batchSupportType').value;
    
    if (!date || !service || !staff || !supportType) {
      alert('å¿…é ˆé …ç›®ï¼ˆè¨˜éŒ²æ—¥ã€ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ã€è¨˜éŒ²è€…åã€æ”¯æ´å†…å®¹ï¼‰ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    // æ”¯æ´å†…å®¹ãƒ‡ãƒ¼ã‚¿åé›†
    const startTime = document.getElementById('batchStartTime').value;
    const endTime = document.getElementById('batchEndTime').value;
    const condition = document.getElementById('batchCondition').value;
    const location = document.getElementById('batchLocation').value;
    const activity = document.getElementById('batchActivity').value;
    const detail = document.getElementById('batchDetail').value.trim();
    const note = document.getElementById('batchNote').value.trim();
    
    let timeRange = '';
    if (startTime && endTime) {
      timeRange = `${startTime}ã€œ${endTime}`;
    } else if (startTime) {
      timeRange = `${startTime}ã€œ`;
    } else if (endTime) {
      timeRange = `ã€œ${endTime}`;
    }
    
    const supportContent = {
      type: supportType,
      timeRange,
      cond: condition,
      location,
      activity,
      detail,
      note
    };
    
    // é¸æŠã•ã‚ŒãŸå„åˆ©ç”¨è€…ã«å¯¾ã—ã¦è¨˜éŒ²ã‚’ä½œæˆ
    let savedCount = 0;
    selectedUserIds.forEach(index => {
      const user = masterUsers[index];
      
      const record = {
        date,
        service,
        user: user.name,
        staff,
        recordType: 'support',
        supportContents: [supportContent]
      };
      
      records.push(record);
      savedCount++;
    });
    
    saveRecords();
    filtered = [...records];
    renderTable();
    
    alert(`âœ“ ${savedCount}äººåˆ†ã®æ”¯æ´è¨˜éŒ²ã‚’ä¸€æ‹¬ä¿å­˜ã—ã¾ã—ãŸï¼`);
    closeBatchModal();
  }
  
  // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿
  function saveRecords() {
    localStorage.setItem('records', JSON.stringify(records));
  }
  
  function saveMasterData() {
    localStorage.setItem('masterUsers', JSON.stringify(masterUsers));
    localStorage.setItem('masterServices', JSON.stringify(masterServices));
    localStorage.setItem('masterStaff', JSON.stringify(masterStaff));
    localStorage.setItem('masterSupportTypes', JSON.stringify(masterSupportTypes));
    localStorage.setItem('masterConditions', JSON.stringify(masterConditions));
    localStorage.setItem('masterLocations', JSON.stringify(masterLocations));
    localStorage.setItem('masterActivityTypes', JSON.stringify(masterActivityTypes));
    localStorage.setItem('supportConditionMap', JSON.stringify(supportConditionMap));
  }
  
  function loadMasterData() {
    renderMasterLists();
  }
  
  // éŸ³å£°å…¥åŠ›åˆæœŸåŒ–
  function initSpeechRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'ja-JP';
      recognition.continuous = false;
      recognition.interimResults = false;
      
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        if (currentVoiceInput) {
          currentVoiceInput.value += (currentVoiceInput.value ? ' ' : '') + transcript;
        }
      };
      
      recognition.onerror = (event) => {
        console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', event.error);
        alert('éŸ³å£°èªè­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + event.error);
      };
    } else {
      console.warn('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
    }
  }
  
  function startVoiceInput(textarea) {
    if (!recognition) {
      alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
      return;
    }
    
    currentVoiceInput = textarea;
    recognition.start();
  }
  
  // ãƒã‚¹ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«
  function openMasterModal() {
    renderMasterLists();
    document.getElementById('masterModal').style.display = 'block';
  }
  
  function closeMasterModal() {
    document.getElementById('masterModal').style.display = 'none';
  }
  
  function switchMasterTab(tabName) {
    document.querySelectorAll('.master-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.master-tab-content').forEach(content => content.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(`tab-${tabName}`).classList.add('active');
  }
  
  // åŒæœŸãƒ¢ãƒ¼ãƒ€ãƒ«
  function openSyncModal() {
    const url = localStorage.getItem('syncUrl') || '';
    document.getElementById('syncUrl').value = url;
    document.getElementById('syncModal').style.display = 'block';
  }
  
  function closeSyncModal() {
    document.getElementById('syncModal').style.display = 'none';
  }
  
  function saveSyncUrl() {
    const url = document.getElementById('syncUrl').value.trim();
    if (url) {
      localStorage.setItem('syncUrl', url);
      alert('âœ“ åŒæœŸURLã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    } else {
      alert('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    }
  }
  
  function showSyncStatus(message, isSuccess) {
    const statusEl = document.getElementById('syncStatus');
    statusEl.textContent = message;
    statusEl.className = 'sync-status ' + (isSuccess ? 'success' : 'error');
    statusEl.style.display = 'block';
    
    setTimeout(() => {
      statusEl.style.display = 'none';
    }, 5000);
  }
  
  async function syncToCloud() {
    const url = localStorage.getItem('syncUrl');
    if (!url) {
      alert('å…ˆã«åŒæœŸURLã‚’è¨­å®šã—ã¦ãã ã•ã„');
      return;
    }
    
    if (!confirm('ãƒ‡ãƒ¼ã‚¿ã‚’Google Sheetsã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ')) {
      return;
    }
    
    try {
      const data = {
        records,
        masterUsers,
        masterServices,
        masterStaff,
        masterSupportTypes,
        masterConditions,
        masterLocations,
        masterActivityTypes,
        supportConditionMap
      };
      
      const response = await fetch(url, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      
      showSyncStatus('âœ“ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', true);
    } catch (error) {
      showSyncStatus('âœ— ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, false);
    }
  }
  
  async function syncFromCloud() {
    const url = localStorage.getItem('syncUrl');
    if (!url) {
      alert('å…ˆã«åŒæœŸURLã‚’è¨­å®šã—ã¦ãã ã•ã„');
      return;
    }
    
    if (!confirm('Google Sheetsã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ\nâ€»ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™')) {
      return;
    }
    
    try {
      const response = await fetch(url);
      const data = await response.json();
      
      if (data.records) records = data.records;
      if (data.masterUsers) masterUsers = data.masterUsers;
      if (data.masterServices) masterServices = data.masterServices;
      if (data.masterStaff) masterStaff = data.masterStaff;
      if (data.masterSupportTypes) masterSupportTypes = data.masterSupportTypes;
      if (data.masterConditions) masterConditions = data.masterConditions;
      if (data.masterLocations) masterLocations = data.masterLocations;
      if (data.masterActivityTypes) masterActivityTypes = data.masterActivityTypes;
      if (data.supportConditionMap) supportConditionMap = data.supportConditionMap;
      
      saveRecords();
      saveMasterData();
      
      filtered = [...records];
      renderTable();
      updateFilterOptions();
      renderMasterLists();
      
      showSyncStatus('âœ“ ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', true);
    } catch (error) {
      showSyncStatus('âœ— ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, false);
    }
  }
  
  // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿è¿½åŠ é–¢æ•°
  function addUser() {
    const name = document.getElementById('newUserName').value.trim();
    const service = document.getElementById('newUserService').value;
    
    if (!name || !service) {
      alert('åˆ©ç”¨è€…åã¨ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    masterUsers.push({ name, service });
    saveMasterData();
    renderMasterLists();
    
    document.getElementById('newUserName').value = '';
    document.getElementById('newUserService').value = '';
  }
  
  function deleteUser(index) {
    if (confirm('ã“ã®åˆ©ç”¨è€…ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      masterUsers.splice(index, 1);
      saveMasterData();
      renderMasterLists();
    }
  }
  
  function addService() {
    const service = document.getElementById('newService').value.trim();
    if (!service) {
      alert('ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (masterServices.includes(service)) {
      alert('ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
      return;
    }
    
    masterServices.push(service);
    saveMasterData();
    renderMasterLists();
    updateFilterOptions();
    
    document.getElementById('newService').value = '';
  }
  
  function deleteService(index) {
    if (confirm('ã“ã®ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      masterServices.splice(index, 1);
      saveMasterData();
      renderMasterLists();
      updateFilterOptions();
    }
  }
  
  function addStaff() {
    const staff = document.getElementById('newStaff').value.trim();
    if (!staff) {
      alert('è¨˜éŒ²è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (masterStaff.includes(staff)) {
      alert('ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
      return;
    }
    
    masterStaff.push(staff);
    saveMasterData();
    renderMasterLists();
    
    document.getElementById('newStaff').value = '';
  }
  
  function deleteStaff(index) {
    if (confirm('ã“ã®è¨˜éŒ²è€…ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      masterStaff.splice(index, 1);
      saveMasterData();
      renderMasterLists();
    }
  }
  
  function addSupportType() {
    const type = document.getElementById('newSupportType').value.trim();
    if (!type) {
      alert('æ”¯æ´å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (masterSupportTypes.includes(type)) {
      alert('ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
      return;
    }
    
    masterSupportTypes.push(type);
    saveMasterData();
    renderMasterLists();
    
    document.getElementById('newSupportType').value = '';
  }
  
  function deleteSupportType(index) {
    if (confirm('ã“ã®æ”¯æ´å†…å®¹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      const type = masterSupportTypes[index];
      masterSupportTypes.splice(index, 1);
      delete supportConditionMap[type];
      saveMasterData();
      renderMasterLists();
    }
  }
  
  function addCondition() {
    const condition = document.getElementById('newCondition').value.trim();
    if (!condition) {
      alert('æ§˜å­ãƒ»çŠ¶æ…‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (masterConditions.includes(condition)) {
      alert('ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
      return;
    }
    
    masterConditions.push(condition);
    saveMasterData();
    renderMasterLists();
    
    document.getElementById('newCondition').value = '';
  }
  
  function deleteCondition(index) {
    if (confirm('ã“ã®æ§˜å­ãƒ»çŠ¶æ…‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      masterConditions.splice(index, 1);
      saveMasterData();
      renderMasterLists();
    }
  }
  
  function addLocation() {
    const location = document.getElementById('newLocation').value.trim();
    if (!location) {
      alert('æ´»å‹•å ´æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (masterLocations.includes(location)) {
      alert('ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
      return;
    }
    
    masterLocations.push(location);
    saveMasterData();
    renderMasterLists();
    
    document.getElementById('newLocation').value = '';
  }
  
  function deleteLocation(index) {
    if (confirm('ã“ã®æ´»å‹•å ´æ‰€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      masterLocations.splice(index, 1);
      saveMasterData();
      renderMasterLists();
    }
  }
  
  function addActivityType() {
    const type = document.getElementById('newActivityType').value.trim();
    if (!type) {
      alert('æ´»å‹•å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (masterActivityTypes.includes(type)) {
      alert('ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
      return;
    }
    
    masterActivityTypes.push(type);
    saveMasterData();
    renderMasterLists();
    
    document.getElementById('newActivityType').value = '';
  }
  
  function deleteActivityType(index) {
    if (confirm('ã“ã®æ´»å‹•å†…å®¹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      masterActivityTypes.splice(index, 1);
      saveMasterData();
      renderMasterLists();
    }
  }
  
  function addConditionMapping() {
    const supportType = document.getElementById('mappingSupportType').value;
    const condition = document.getElementById('mappingCondition').value;
    
    if (!supportType || !condition) {
      alert('æ”¯æ´å†…å®¹ã¨æ§˜å­ãƒ»çŠ¶æ…‹ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    
    if (!supportConditionMap[supportType]) {
      supportConditionMap[supportType] = [];
    }
    
    if (supportConditionMap[supportType].includes(condition)) {
      alert('ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
      return;
    }
    
    supportConditionMap[supportType].push(condition);
    saveMasterData();
    renderMasterLists();
  }
  
  function renderMasterLists() {
    // åˆ©ç”¨è€…ãƒªã‚¹ãƒˆ
    const userListEl = document.getElementById('userList');
    userListEl.innerHTML = '';
    masterUsers.forEach((user, index) => {
      const item = document.createElement('div');
      item.className = 'master-item';
      item.innerHTML = `
        <div class="master-item-info">
          <div class="master-item-name">${user.name}</div>
          <div class="master-item-detail">ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†: ${user.service}</div>
        </div>
        <button class="btn-delete" onclick="deleteUser(${index})">å‰Šé™¤</button>
      `;
      userListEl.appendChild(item);
    });
    
    // ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ã®é¸æŠè‚¢æ›´æ–°ï¼ˆåˆ©ç”¨è€…è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ç”¨ï¼‰
    const newUserServiceEl = document.getElementById('newUserService');
    newUserServiceEl.innerHTML = '<option value="">ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†</option>';
    masterServices.forEach(service => {
      const option = document.createElement('option');
      option.value = service;
      option.textContent = service;
      newUserServiceEl.appendChild(option);
    });
    
    // ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ãƒªã‚¹ãƒˆ
    const serviceListEl = document.getElementById('serviceList');
    serviceListEl.innerHTML = '';
    masterServices.forEach((service, index) => {
      const item = document.createElement('div');
      item.className = 'master-item';
      item.innerHTML = `
        <div class="master-item-info">
          <div class="master-item-name">${service}</div>
        </div>
        <button class="btn-delete" onclick="deleteService(${index})">å‰Šé™¤</button>
      `;
      serviceListEl.appendChild(item);
    });
    
    // è¨˜éŒ²è€…ãƒªã‚¹ãƒˆ
    const staffListEl = document.getElementById('staffList');
    staffListEl.innerHTML = '';
    masterStaff.forEach((staff, index) => {
      const item = document.createElement('div');
      item.className = 'master-item';
      item.innerHTML = `
        <div class="master-item-info">
          <div class="master-item-name">${staff}</div>
        </div>
        <button class="btn-delete" onclick="deleteStaff(${index})">å‰Šé™¤</button>
      `;
      staffListEl.appendChild(item);
    });
    
    // æ”¯æ´å†…å®¹ãƒªã‚¹ãƒˆ
    const supportTypeListEl = document.getElementById('supportTypeList');
    supportTypeListEl.innerHTML = '';
    masterSupportTypes.forEach((type, index) => {
      const item = document.createElement('div');
      item.className = 'master-item';
      item.innerHTML = `
        <div class="master-item-info">
          <div class="master-item-name">${type}</div>
        </div>
        <button class="btn-delete" onclick="deleteSupportType(${index})">å‰Šé™¤</button>
      `;
      supportTypeListEl.appendChild(item);
    });
    
    // æ§˜å­ãƒ»çŠ¶æ…‹ãƒªã‚¹ãƒˆ
    const conditionListEl = document.getElementById('conditionList');
    conditionListEl.innerHTML = '';
    masterConditions.forEach((condition, index) => {
      const item = document.createElement('div');
      item.className = 'master-item';
      item.innerHTML = `
        <div class="master-item-info">
          <div class="master-item-name">${condition}</div>
        </div>
        <button class="btn-delete" onclick="deleteCondition(${index})">å‰Šé™¤</button>
      `;
      conditionListEl.appendChild(item);
    });
    
    // é€£å‹•è¨­å®šç”¨ã®æ”¯æ´å†…å®¹é¸æŠè‚¢
    const mappingSupportTypeEl = document.getElementById('mappingSupportType');
    mappingSupportTypeEl.innerHTML = '<option value="">æ”¯æ´å†…å®¹ã‚’é¸æŠ</option>';
    masterSupportTypes.forEach(type => {
      const option = document.createElement('option');
      option.value = type;
      option.textContent = type;
      mappingSupportTypeEl.appendChild(option);
    });
    
    // é€£å‹•è¨­å®šç”¨ã®æ§˜å­ãƒ»çŠ¶æ…‹é¸æŠè‚¢
    const mappingConditionEl = document.getElementById('mappingCondition');
    mappingConditionEl.innerHTML = '';
    masterConditions.forEach(cond => {
      const option = document.createElement('option');
      option.value = cond;
      option.textContent = cond;
      mappingConditionEl.appendChild(option);
    });
    
    // é€£å‹•ãƒãƒƒãƒ”ãƒ³ã‚°è¡¨ç¤º
    const conditionMappingListEl = document.getElementById('conditionMappingList');
    conditionMappingListEl.innerHTML = '';
    Object.keys(supportConditionMap).forEach(supportType => {
      const conditions = supportConditionMap[supportType];
      const item = document.createElement('div');
      item.className = 'master-item';
      item.style.flexDirection = 'column';
      item.style.alignItems = 'flex-start';
      
      let conditionChips = '';
      conditions.forEach(cond => {
        conditionChips += `<span class="condition-chip">${cond}</span>`;
      });
      
      item.innerHTML = `
        <div style="width: 100%;">
          <div class="master-item-name" style="margin-bottom: 8px;">ğŸ“ ${supportType}</div>
          <div class="master-item-mapping">
            ${conditionChips}
          </div>
        </div>
      `;
      conditionMappingListEl.appendChild(item);
    });
    
    // æ´»å‹•å ´æ‰€ãƒªã‚¹ãƒˆ
    const locationListEl = document.getElementById('locationList');
    locationListEl.innerHTML = '';
    masterLocations.forEach((location, index) => {
      const item = document.createElement('div');
      item.className = 'master-item';
      item.innerHTML = `
        <div class="master-item-info">
          <div class="master-item-name">${location}</div>
        </div>
        <button class="btn-delete" onclick="deleteLocation(${index})">å‰Šé™¤</button>
      `;
      locationListEl.appendChild(item);
    });
    
    // æ´»å‹•å†…å®¹ãƒªã‚¹ãƒˆ
    const activityTypeListEl = document.getElementById('activityTypeList');
    activityTypeListEl.innerHTML = '';
    masterActivityTypes.forEach((type, index) => {
      const item = document.createElement('div');
      item.className = 'master-item';
      item.innerHTML = `
        <div class="master-item-info">
          <div class="master-item-name">${type}</div>
        </div>
        <button class="btn-delete" onclick="deleteActivityType(${index})">å‰Šé™¤</button>
      `;
      activityTypeListEl.appendChild(item);
    });
  }
  
  function updateUserOptions(selectElement, serviceValue) {
    const row = selectElement.closest('.basic-info-row');
    if (!row) return;
    
    const userSelect = row.querySelector('.row-user');
    if (!userSelect) return;
    
    userSelect.innerHTML = '<option value="">åˆ©ç”¨è€…ã‚’é¸æŠ</option>';
    
    if (serviceValue) {
      const filteredUsers = masterUsers.filter(u => u.service === serviceValue);
      filteredUsers.forEach(user => {
        const option = document.createElement('option');
        option.value = user.name;
        option.textContent = user.name;
        userSelect.appendChild(option);
      });
    }
  }
  
  // æ”¯æ´å†…å®¹é¸æŠæ™‚ã«æ§˜å­çŠ¶æ…‹ã‚’é€£å‹•æ›´æ–°
  function updateConditionOptions(supportTypeSelect) {
    const supportType = supportTypeSelect.value;
    const row = supportTypeSelect.closest('.support-content-row');
    if (!row) return;
    
    const condSelects = row.querySelectorAll('select[class*="row-cond-"]');
    condSelects.forEach(condSelect => {
      const currentValue = condSelect.value;
      condSelect.innerHTML = '<option value="">é¸æŠ</option>';
      
      if (supportType && supportConditionMap[supportType]) {
        supportConditionMap[supportType].forEach(cond => {
          const option = document.createElement('option');
          option.value = cond;
          option.textContent = cond;
          condSelect.appendChild(option);
        });
        if (supportConditionMap[supportType].includes(currentValue)) {
          condSelect.value = currentValue;
        }
      } else {
        masterConditions.forEach(cond => {
          const option = document.createElement('option');
          option.value = cond;
          option.textContent = cond;
          condSelect.appendChild(option);
        });
        condSelect.value = currentValue;
      }
    });
  }
  
  // å…¥åŠ›ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆ
  function toggleInputType(rowId) {
    const row = document.getElementById(`input-row-${rowId}`);
    if (!row) return;
    
    const supportArea = row.querySelector('.support-input-area');
    const vitalArea = row.querySelector('.vital-input-area');
    const toggleBtn = row.querySelector('.btn-toggle');
    
    if (supportArea.classList.contains('active')) {
      supportArea.classList.remove('active');
      vitalArea.classList.add('active');
      toggleBtn.textContent = 'ğŸ“ æ”¯æ´å†…å®¹å…¥åŠ›ã¸åˆ‡æ›¿';
      toggleBtn.classList.add('active');
    } else {
      vitalArea.classList.remove('active');
      supportArea.classList.add('active');
      toggleBtn.textContent = 'ğŸ¥ ãƒã‚¤ã‚¿ãƒ«å…¥åŠ›ã¸åˆ‡æ›¿';
      toggleBtn.classList.remove('active');
    }
  }
  
  // æ”¯æ´å†…å®¹ã‚’ä½œæˆ
  function createSupportContent(rowId, supportIndex) {
    let typeOptions = '<option value="">é¸æŠ</option>';
    masterSupportTypes.forEach(type => {
      typeOptions += `<option value="${type}">${type}</option>`;
    });
    
    let condOptions = '<option value="">é¸æŠ</option>';
    masterConditions.forEach(cond => {
      condOptions += `<option value="${cond}">${cond}</option>`;
    });
    
    let locationOptions = '<option value="">é¸æŠ</option>';
    masterLocations.forEach(location => {
      locationOptions += `<option value="${location}">${location}</option>`;
    });
    
    let activityOptions = '<option value="">é¸æŠ</option>';
    masterActivityTypes.forEach(activity => {
      activityOptions += `<option value="${activity}">${activity}</option>`;
    });
    
    const supportDiv = document.createElement('div');
    supportDiv.className = 'support-content-row';
    supportDiv.id = `support-${rowId}-${supportIndex}`;
    
    supportDiv.innerHTML = `
      <div class="input-field">
        <label>
          ${supportIndex === 1 ? '<span class="support-number">æ”¯æ´' + supportIndex + '</span> ' : ''}æ”¯æ´å†…å®¹${supportIndex === 1 ? '<span class="required">*</span>' : ''}
        </label>
        <select class="row-type-${supportIndex}" ${supportIndex === 1 ? 'required' : ''} onchange="updateConditionOptions(this)">
          ${typeOptions}
        </select>
      </div>
      
      <div class="input-field">
        <label>æ™‚é–“</label>
        <div class="input-field-time">
          <input type="time" class="row-start-time-${supportIndex}">
          <span>ã€œ</span>
          <input type="time" class="row-end-time-${supportIndex}">
        </div>
      </div>
      
      <div class="input-field">
        <label>æ§˜å­</label>
        <select class="row-cond-${supportIndex}">
          ${condOptions}
        </select>
      </div>
      
      <div class="input-field">
        <label>å ´æ‰€</label>
        <select class="row-location-${supportIndex}">
          ${locationOptions}
        </select>
      </div>
      
      <div class="input-field">
        <label>æ´»å‹•</label>
        <select class="row-activity-${supportIndex}">
          ${activityOptions}
        </select>
      </div>
      
      <div class="input-field">
        <label>
          è©³ç´°
          <button type="button" class="btn-voice" onclick="startVoiceInput(this.closest('.input-field').querySelector('textarea'))" title="éŸ³å£°">ğŸ¤</button>
        </label>
        <textarea class="row-detail-${supportIndex}" placeholder="è©³ç´°"></textarea>
      </div>
      
      <div class="input-field">
        <label>
          ç‰¹è¨˜
          <button type="button" class="btn-voice" onclick="startVoiceInput(this.closest('.input-field').querySelector('textarea'))" title="éŸ³å£°">ğŸ¤</button>
        </label>
        <textarea class="row-note-${supportIndex}" placeholder="ç‰¹è¨˜"></textarea>
      </div>
      
      ${supportIndex > 1 ? `
      <div class="support-actions">
        <button type="button" class="btn btn-remove" onclick="removeSupportContent(${rowId}, ${supportIndex})">âœ• å‰Šé™¤</button>
      </div>
      ` : ''}
    `;
    
    return supportDiv;
  }
  
  // æ”¯æ´å†…å®¹ã‚’è¿½åŠ 
  function addSupportContent(rowId) {
    const row = document.getElementById(`input-row-${rowId}`);
    if (!row) return;
    
    const supportSection = row.querySelector('.support-content-section');
    if (!supportSection) return;
    
    const currentCount = supportCounterMap[rowId] || 1;
    const newIndex = currentCount + 1;
    
    const newSupport = createSupportContent(rowId, newIndex);
    
    const addButton = supportSection.querySelector('.support-add-button');
    supportSection.insertBefore(newSupport, addButton);
    
    supportCounterMap[rowId] = newIndex;
    
    setTimeout(() => {
      newSupport.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
  }
  
  // æ”¯æ´å†…å®¹ã‚’å‰Šé™¤
  function removeSupportContent(rowId, supportIndex) {
    if (!confirm('ã“ã®æ”¯æ´å†…å®¹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      return;
    }
    
    const supportDiv = document.getElementById(`support-${rowId}-${supportIndex}`);
    if (supportDiv) {
      supportDiv.remove();
    }
  }
  
  // ãƒã‚¤ã‚¿ãƒ«æ¸¬å®šã‚’ä½œæˆ
  function createVitalEntry(rowId, vitalIndex) {
    const vitalDiv = document.createElement('div');
    vitalDiv.className = 'vital-entry';
    vitalDiv.id = `vital-${rowId}-${vitalIndex}`;
    
    vitalDiv.innerHTML = `
      <div class="vital-header">
        <span class="vital-number">æ¸¬å®š${vitalIndex}</span>
        <div class="vital-time">
          <label style="margin: 0;">æ¸¬å®šæ™‚åˆ»:</label>
          <input type="time" class="row-vital-time-${vitalIndex}">
        </div>
      </div>
      
      <div class="vital-grid">
        <div class="vital-field">
          <label>ä½“æ¸© (â„ƒ)</label>
          <input type="number" step="0.1" class="row-vital-temp-${vitalIndex}" placeholder="36.5">
        </div>
        <div class="vital-field">
          <label>è¡€åœ§ (ä¸Š)</label>
          <input type="number" class="row-vital-bp-sys-${vitalIndex}" placeholder="120">
        </div>
        <div class="vital-field">
          <label>è¡€åœ§ (ä¸‹)</label>
          <input type="number" class="row-vital-bp-dia-${vitalIndex}" placeholder="80">
        </div>
        <div class="vital-field">
          <label>è„ˆæ‹ (å›/åˆ†)</label>
          <input type="number" class="row-vital-pulse-${vitalIndex}" placeholder="70">
        </div>
        <div class="vital-field">
          <label>SpO2 (%)</label>
          <input type="number" class="row-vital-spo2-${vitalIndex}" placeholder="98">
        </div>
        <div class="vital-field">
          <label>å‘¼å¸æ•° (å›/åˆ†)</label>
          <input type="number" class="row-vital-resp-${vitalIndex}" placeholder="16">
        </div>
      </div>
      
      <div class="input-field" style="margin-top: 12px;">
        <label>
          ãƒã‚¤ã‚¿ãƒ«ç‰¹è¨˜äº‹é …
          <button type="button" class="btn-voice" onclick="startVoiceInput(this.closest('.input-field').querySelector('textarea'))" title="éŸ³å£°å…¥åŠ›">ğŸ¤</button>
        </label>
        <textarea class="row-vital-note-${vitalIndex}" placeholder="ãƒã‚¤ã‚¿ãƒ«ã«é–¢ã™ã‚‹ç‰¹è¨˜äº‹é …"></textarea>
      </div>
      
      ${vitalIndex > 1 ? `
      <div class="support-actions">
        <button type="button" class="btn btn-remove" onclick="removeVitalEntry(${rowId}, ${vitalIndex})">âœ• ã“ã®æ¸¬å®šã‚’å‰Šé™¤</button>
      </div>
      ` : ''}
    `;
    
    return vitalDiv;
  }
  
  // ãƒã‚¤ã‚¿ãƒ«æ¸¬å®šã‚’è¿½åŠ 
  function addVitalEntry(rowId) {
    const row = document.getElementById(`input-row-${rowId}`);
    if (!row) return;
    
    const vitalSection = row.querySelector('.vital-section');
    if (!vitalSection) return;
    
    const currentCount = vitalCounterMap[rowId] || 1;
    const newIndex = currentCount + 1;
    
    const newVital = createVitalEntry(rowId, newIndex);
    
    const addButton = vitalSection.querySelector('.vital-add-button');
    vitalSection.insertBefore(newVital, addButton);
    
    vitalCounterMap[rowId] = newIndex;
    
    setTimeout(() => {
      newVital.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
  }
  
  // ãƒã‚¤ã‚¿ãƒ«æ¸¬å®šã‚’å‰Šé™¤
  function removeVitalEntry(rowId, vitalIndex) {
    if (!confirm('ã“ã®æ¸¬å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      return;
    }
    
    const vitalDiv = document.getElementById(`vital-${rowId}-${vitalIndex}`);
    if (vitalDiv) {
      vitalDiv.remove();
    }
  }
  
  function createInputRow() {
    const rowId = ++rowIdCounter;
    const today = new Date().toISOString().split('T')[0];
    
    supportCounterMap[rowId] = 1;
    vitalCounterMap[rowId] = 1;
    
    const row = document.createElement('div');
    row.className = 'input-row';
    row.id = `input-row-${rowId}`;
    
    let serviceOptions = '<option value="">é¸æŠ</option>';
    masterServices.forEach(service => {
      serviceOptions += `<option value="${service}">${service}</option>`;
    });
    
    let staffOptions = '<option value="">é¸æŠ</option>';
    masterStaff.forEach(staff => {
      staffOptions += `<option value="${staff}">${staff}</option>`;
    });
    
    row.innerHTML = `
      <div class="basic-info-row">
        <div class="input-field">
          <label>è¨˜éŒ²æ—¥ <span class="required">*</span></label>
          <input type="date" class="row-date" value="${today}" required>
        </div>
        
        <div class="input-field">
          <label>ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ† <span class="required">*</span></label>
          <select class="row-service" required onchange="updateUserOptions(this, this.value)">
            ${serviceOptions}
          </select>
        </div>
        
        <div class="input-field">
          <label>åˆ©ç”¨è€…å <span class="required">*</span></label>
          <select class="row-user" required>
            <option value="">åˆ©ç”¨è€…ã‚’é¸æŠ</option>
          </select>
        </div>
        
        <div class="input-field">
          <label>è¨˜éŒ²è€…å <span class="required">*</span></label>
          <select class="row-staff" required>
            ${staffOptions}
          </select>
        </div>
      </div>
      
      <button type="button" class="btn btn-toggle" onclick="toggleInputType(${rowId})">ğŸ¥ ãƒã‚¤ã‚¿ãƒ«å…¥åŠ›ã¸åˆ‡æ›¿</button>
      
      <!-- æ”¯æ´å†…å®¹å…¥åŠ›ã‚¨ãƒªã‚¢ -->
      <div class="support-input-area active">
        <div class="support-content-section">
          <div class="support-label">
            <span>ğŸ“ æ”¯æ´å†…å®¹</span>
            <button type="button" class="btn btn-add" onclick="addSupportContent(${rowId})">â• æ”¯æ´å†…å®¹è¿½åŠ </button>
          </div>
          <div class="support-add-button"></div>
        </div>
      </div>
      
      <!-- ãƒã‚¤ã‚¿ãƒ«å…¥åŠ›ã‚¨ãƒªã‚¢ -->
      <div class="vital-input-area">
        <div class="vital-section">
          <div class="support-label">
            <span>ğŸ¥ ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³</span>
            <button type="button" class="btn btn-add" onclick="addVitalEntry(${rowId})">â• æ¸¬å®šè¿½åŠ </button>
          </div>
          <div class="vital-add-button"></div>
        </div>
      </div>
      
      <div class="row-actions">
        <button type="button" class="btn btn-save" onclick="saveRow(${rowId})">âœ“ ä¿å­˜</button>
        <button type="button" class="btn btn-cancel" onclick="removeRow(${rowId})">âœ• ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    `;
    
    const supportSection = row.querySelector('.support-content-section');
    const firstSupport = createSupportContent(rowId, 1);
    const supportAddButton = supportSection.querySelector('.support-add-button');
    supportSection.insertBefore(firstSupport, supportAddButton);
    
    const vitalSection = row.querySelector('.vital-section');
    const firstVital = createVitalEntry(rowId, 1);
    const vitalAddButton = vitalSection.querySelector('.vital-add-button');
    vitalSection.insertBefore(firstVital, vitalAddButton);
    
    return row;
  }

  function addInputRow() {
    const container = document.getElementById('inputContainer');
    const newRow = createInputRow();
    container.appendChild(newRow);
    newRow.classList.add('active');
    
    setTimeout(() => {
      newRow.scrollIntoView({ behavior: 'smooth', block: 'start' });
      const firstInput = newRow.querySelector('.row-date');
      if (firstInput) firstInput.focus();
    }, 100);
  }

  function removeRow(rowId) {
    const row = document.getElementById(`input-row-${rowId}`);
    if (row) {
      row.remove();
      delete supportCounterMap[rowId];
      delete vitalCounterMap[rowId];
    }
  }

  function saveRow(rowId) {
    const row = document.getElementById(`input-row-${rowId}`);
    if (!row) return;
    
    const date = row.querySelector('.row-date').value;
    const service = row.querySelector('.row-service').value;
    const user = row.querySelector('.row-user').value;
    const staff = row.querySelector('.row-staff').value;
    
    if (!date || !service || !user || !staff) {
      alert('å¿…é ˆé …ç›®ï¼ˆè¨˜éŒ²æ—¥ã€ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ã€åˆ©ç”¨è€…åã€è¨˜éŒ²è€…åï¼‰ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    const supportArea = row.querySelector('.support-input-area');
    const vitalArea = row.querySelector('.vital-input-area');
    
    let record = { 
      date, 
      service, 
      user, 
      staff 
    };
    
    if (supportArea.classList.contains('active')) {
      const type1 = row.querySelector('.row-type-1').value;
      if (!type1) {
        alert('æ”¯æ´å†…å®¹1ã¯å¿…é ˆã§ã™');
        return;
      }
      
      const supportContents = [];
      const maxSupport = supportCounterMap[rowId] || 1;
      
      for (let i = 1; i <= maxSupport; i++) {
        const typeEl = row.querySelector(`.row-type-${i}`);
        if (!typeEl) continue;
        
        const type = typeEl.value;
        if (type) {
          const startTime = row.querySelector(`.row-start-time-${i}`)?.value || '';
          const endTime = row.querySelector(`.row-end-time-${i}`)?.value || '';
          const cond = row.querySelector(`.row-cond-${i}`)?.value || '';
          const location = row.querySelector(`.row-location-${i}`)?.value || '';
          const activity = row.querySelector(`.row-activity-${i}`)?.value || '';
          const detail = row.querySelector(`.row-detail-${i}`)?.value.trim() || '';
          const note = row.querySelector(`.row-note-${i}`)?.value.trim() || '';
          
          let timeRange = '';
          if (startTime && endTime) {
            timeRange = `${startTime}ã€œ${endTime}`;
          } else if (startTime) {
            timeRange = `${startTime}ã€œ`;
          } else if (endTime) {
            timeRange = `ã€œ${endTime}`;
          }
          
          supportContents.push({
            type,
            timeRange,
            cond,
            location,
            activity,
            detail,
            note
          });
        }
      }
      
      if (supportContents.length === 0) {
        alert('å°‘ãªãã¨ã‚‚1ã¤ã®æ”¯æ´å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      record.recordType = 'support';
      record.supportContents = supportContents;
      
      alert(`âœ“ æ”¯æ´è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ï¼ˆæ”¯æ´å†…å®¹: ${supportContents.length}ä»¶ï¼‰`);
    }
    else if (vitalArea.classList.contains('active')) {
      const vitalMeasurements = [];
      const maxVital = vitalCounterMap[rowId] || 1;
      
      for (let i = 1; i <= maxVital; i++) {
        const timeEl = row.querySelector(`.row-vital-time-${i}`);
        if (!timeEl) continue;
        
        const time = timeEl.value || '';
        const temp = row.querySelector(`.row-vital-temp-${i}`)?.value || '';
        const bpSys = row.querySelector(`.row-vital-bp-sys-${i}`)?.value || '';
        const bpDia = row.querySelector(`.row-vital-bp-dia-${i}`)?.value || '';
        const pulse = row.querySelector(`.row-vital-pulse-${i}`)?.value || '';
        const spo2 = row.querySelector(`.row-vital-spo2-${i}`)?.value || '';
        const resp = row.querySelector(`.row-vital-resp-${i}`)?.value || '';
        const note = row.querySelector(`.row-vital-note-${i}`)?.value.trim() || '';
        
        if (temp || bpSys || bpDia || pulse || spo2 || resp) {
          vitalMeasurements.push({
            time,
            temp,
            bpSys,
            bpDia,
            pulse,
            spo2,
            resp,
            note
          });
        }
      }
      
      if (vitalMeasurements.length === 0) {
        alert('å°‘ãªãã¨ã‚‚1ã¤ã®ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      record.recordType = 'vital';
      record.vitalMeasurements = vitalMeasurements;
      
      alert(`âœ“ ãƒã‚¤ã‚¿ãƒ«è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ï¼ˆæ¸¬å®šå›æ•°: ${vitalMeasurements.length}å›ï¼‰`);
    }
    
    records.push(record);
    saveRecords();
    
    filtered = [...records];
    renderTable();
    removeRow(rowId);
  }

  function renderTable() {
    const tbody = document.querySelector('#recordTable tbody');
    tbody.innerHTML = '';
    
    if (filtered.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px; color: #999;">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      return;
    }
    
    const sorted = [...filtered].sort((a, b) => b.date.localeCompare(a.date));
    
    sorted.forEach(r => {
      const tr = document.createElement('tr');
      
      let contentHtml = '';
      
      if (r.recordType === 'support') {
        r.supportContents.forEach((s, idx) => {
          if (idx > 0) contentHtml += '<hr style="margin: 8px 0; border: none; border-top: 1px solid #ddd;">';
          contentHtml += '<div style="margin-bottom: 5px;">';
          contentHtml += `<strong>ã€${idx + 1}ã€‘${s.type}</strong><br>`;
          if (s.timeRange) contentHtml += `â° ${s.timeRange}<br>`;
          if (s.cond) contentHtml += `ğŸ˜Š ${s.cond}<br>`;
          if (s.location) contentHtml += `ğŸ“ ${s.location}ã€€`;
          if (s.activity) contentHtml += `ğŸ¯ ${s.activity}<br>`;
          if (s.detail) contentHtml += `ğŸ“„ ${s.detail}<br>`;
          if (s.note) contentHtml += `ğŸ“Œ ${s.note}`;
          contentHtml += '</div>';
        });
      }
      else if (r.recordType === 'vital') {
        contentHtml += '<div style="background: #ffe0e0; padding: 8px; border-radius: 4px;"><strong>ğŸ¥ ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³</strong>';
        r.vitalMeasurements.forEach((v, idx) => {
          if (idx > 0) contentHtml += '<hr style="margin: 8px 0; border: none; border-top: 1px solid #ddd;">';
          contentHtml += '<div style="margin-top: 6px;">';
          if (v.time) contentHtml += `<strong>â° ${v.time}</strong><br>`;
          if (v.temp) contentHtml += `ä½“æ¸©: ${v.temp}â„ƒã€€`;
          if (v.bpSys && v.bpDia) contentHtml += `è¡€åœ§: ${v.bpSys}/${v.bpDia}mmHgã€€`;
          if (v.pulse) contentHtml += `è„ˆæ‹: ${v.pulse}å›/åˆ†ã€€`;
          if (v.spo2) contentHtml += `SpO2: ${v.spo2}%ã€€`;
          if (v.resp) contentHtml += `å‘¼å¸: ${v.resp}å›/åˆ†ã€€`;
          if (v.note) contentHtml += `<br>ğŸ“Œ ${v.note}`;
          contentHtml += '</div>';
        });
        contentHtml += '</div>';
      }
      
      tr.innerHTML = `
        <td>${r.date}</td>
        <td><span class="service-badge badge-${r.service}">${r.service}</span></td>
        <td>${r.user}</td>
        <td>${r.staff}</td>
        <td style="min-width: 300px;">${contentHtml}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function updateFilterOptions() {
    const filterServiceEl = document.getElementById('filterService');
    filterServiceEl.innerHTML = '<option value="">ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ï¼ˆå…¨ã¦ï¼‰</option>';
    masterServices.forEach(service => {
      const option = document.createElement('option');
      option.value = service;
      option.textContent = service;
      filterServiceEl.appendChild(option);
    });
  }

  function applyFilter() {
    const month = document.getElementById('filterMonth').value;
    const service = document.getElementById('filterService').value;
    const user = document.getElementById('filterUser').value.trim().toLowerCase();
    
    filtered = records.filter(r => {
      if (month && !r.date.startsWith(month)) return false;
      if (service && r.service !== service) return false;
      if (user && !r.user.toLowerCase().includes(user)) return false;
      return true;
    });
    
    renderTable();
  }

  function resetFilter() {
    document.getElementById('filterMonth').value = '';
    document.getElementById('filterService').value = '';
    document.getElementById('filterUser').value = '';
    filtered = [...records];
    renderTable();
  }

  function exportExcel() {
    if (filtered.length === 0) {
      alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }
    
    const supportData = [['è¨˜éŒ²æ—¥', 'ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†', 'åˆ©ç”¨è€…å', 'è¨˜éŒ²è€…å', 'æ”¯æ´å†…å®¹', 'æ™‚é–“', 'æ§˜å­ãƒ»çŠ¶æ…‹', 'æ´»å‹•å ´æ‰€', 'æ´»å‹•å†…å®¹', 'æ”¯æ´ã®è©³ç´°', 'ç‰¹è¨˜äº‹é …']];
    
    filtered.forEach(r => {
      if (r.recordType === 'support') {
        r.supportContents.forEach(s => {
          supportData.push([
            r.date,
            r.service,
            r.user,
            r.staff,
            s.type,
            s.timeRange,
            s.cond,
            s.location,
            s.activity,
            s.detail,
            s.note
          ]);
        });
      }
    });
    
    const vitalData = [['è¨˜éŒ²æ—¥', 'ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†', 'åˆ©ç”¨è€…å', 'è¨˜éŒ²è€…å', 'æ¸¬å®šæ™‚åˆ»', 'ä½“æ¸©', 'è¡€åœ§(ä¸Š)', 'è¡€åœ§(ä¸‹)', 'è„ˆæ‹', 'SpO2', 'å‘¼å¸æ•°', 'ç‰¹è¨˜äº‹é …']];
    
    filtered.forEach(r => {
      if (r.recordType === 'vital') {
        r.vitalMeasurements.forEach(v => {
          vitalData.push([
            r.date,
            r.service,
            r.user,
            r.staff,
            v.time,
            v.temp,
            v.bpSys,
            v.bpDia,
            v.pulse,
            v.spo2,
            v.resp,
            v.note
          ]);
        });
      }
    });
    
    const masterData = [['ç¨®åˆ¥', 'ãƒ‡ãƒ¼ã‚¿']];
    
    masterData.push(['åˆ©ç”¨è€…', '']);
    masterUsers.forEach(u => {
      masterData.push(['', `${u.name}ï¼ˆ${u.service}ï¼‰`]);
    });
    
    masterData.push(['ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†', '']);
    masterServices.forEach(s => {
      masterData.push(['', s]);
    });
    
    masterData.push(['è¨˜éŒ²è€…', '']);
    masterStaff.forEach(s => {
      masterData.push(['', s]);
    });
    
    const wb = XLSX.utils.book_new();
    const wsSup = XLSX.utils.aoa_to_sheet(supportData);
    const wsVit = XLSX.utils.aoa_to_sheet(vitalData);
    const wsMas = XLSX.utils.aoa_to_sheet(masterData);
    
    XLSX.utils.book_append_sheet(wb, wsSup, 'æ”¯æ´è¨˜éŒ²');
    XLSX.utils.book_append_sheet(wb, wsVit, 'ãƒã‚¤ã‚¿ãƒ«è¨˜éŒ²');
    XLSX.utils.book_append_sheet(wb, wsMas, 'ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿');
    
    const today = new Date().toISOString().split('T')[0];
    XLSX.writeFile(wb, `æ”¯æ´è¨˜éŒ²_${today}.xlsx`);
    
    alert('âœ“ Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
  }

  function clearAll() {
    if (!confirm('ã™ã¹ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nâ€»ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“')) {
      return;
    }
    
    records = [];
    filtered = [];
    saveRecords();
    renderTable();
    alert('âœ“ ã™ã¹ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  }

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
  document.addEventListener('DOMContentLoaded', () => {
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
    checkSession();
    
    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    loadMasterData();
    renderTable();
    updateFilterOptions();
    initSpeechRecognition();
  });

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  window.onclick = function(event) {
    const masterModal = document.getElementById('masterModal');
    const syncModal = document.getElementById('syncModal');
    const batchModal = document.getElementById('batchModal');
    
    if (event.target === masterModal) {
      closeMasterModal();
    }
    if (event.target === syncModal) {
      closeSyncModal();
    }
    if (event.target === batchModal) {
      closeBatchModal();
    }
  }
</script>
</body>
</html>